#!/usr/bin/env bash
# should be run after function 'sub-env()'
# do disable this step define heroku confif variable 'DISABLE_MIGRATE' to 'true'
source $BIN_DIR/utils

MANAGE_FILE=$(find . -maxdepth 3 -type f -name 'manage.py' -printf '%d\t%P\n' | sort -nk1 | cut -f2 | head -1)
MANAGE_FILE=${MANAGE_FILE:-fakepath}

# use 'DISABLE_MIGRATE' config variable to disable migrate management command
bpwatch start migrate

if [ -f "$MANAGE_FILE" ] && [ ! "$DISABLE_MIGRATE" ]; then
    puts-step "Running migrate"

    python $MANAGE_FILE migrate

    puts-step "Fiinishing migrate"
fi

bpwatch stop migrate
